// =================================================================
// Enhanced Explorer v10.1 (Complete)
//
// KEY ENHANCEMENTS:
// - More focused prompt to improve accuracy and speed.
// - Hardened error handling to ensure it never crashes the orchestrator.
// =================================================================

/**
 * A reusable helper function that implements a per-key fallback sequence for the Gemini API.
 */
async function callGeminiWithFallback(prompt, env) {
  // Using a faster model as default for this high-volume task
  const primaryModel = "gemini-2.0-flash";
  const secondaryModel = "gemini-2.5-pro";
  const keys = (env.GEMINI_API_KEYS || "").split(',').map(k => k.trim()).filter(Boolean);
  if (keys.length === 0) throw new Error("GEMINI_API_KEYS environment variable is not set.");
  const shuffledKeys = keys.sort(() => 0.5 - Math.random());
  for (const key of shuffledKeys) {
    for (const model of [primaryModel, secondaryModel]) {
      try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
          signal: AbortSignal.timeout(45000) // 45s timeout, given the long wall times
        });
        if (res.ok) {
          const result = await res.json();
          if (result.candidates && result.candidates.length > 0) return result;
        }
      } catch (e) { /* Ignore and try next */ }
    }
  }
  throw new Error("All provided API keys failed on both models.");
}

export default {
  async fetch(request, env, ctx) {
    if (request.method !== 'POST') return new Response('Explorer accepts POST only', { status: 405 });

    try {
        const { text_chunk } = await request.json();
        if (!text_chunk) return new Response('Missing text_chunk', { status: 400 });

        const geminiPrompt = `You are an AI data extractor. Your sole task is to extract company names from the provided text.
        
- Focus ONLY on names of companies, startups, or corporate entities.
- IGNORE names of people, places, technologies, and media houses (e.g., "Forbes", "TechCrunch").
- The goal is to identify potential employers in the Indian tech sector.

Your response MUST be a single, valid JSON array of objects in the format: [{"company_name": "string"}]. If no companies are found, return an empty array [].

Article text: """${text_chunk.substring(0, 25000)}"""`;

        const geminiResult = await callGeminiWithFallback(geminiPrompt, env);
        const jsonString = geminiResult.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
        const companies = JSON.parse(jsonString);

        return new Response(JSON.stringify(companies), { headers: { 'Content-Type': 'application/json' } });

    } catch (error) {
        console.error(`A critical error occurred in the explorer: ${error.message}\n${error.stack}`);
        // CRITICAL: Return an empty array on failure so the orchestrator doesn't crash.
        return new Response("[]", { status: 500, headers: { 'Content-Type': 'application/json' } });
    }
  },
};
